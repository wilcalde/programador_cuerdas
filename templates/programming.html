{% extends "base.html" %}

{% block header_title %}üìÖ Programaci√≥n de Producci√≥n{% endblock %}

{% block content %}
<div class="card glass" style="border-left: 4px solid var(--accent-blue);">
    <p>üí° La programaci√≥n es generada por IA bas√°ndose en el backlog y la capacidad de los 28 puestos de Rewinder
        disponible.</p>
</div>

<div style="margin-top: 2rem; display: flex; gap: 1rem;">
    <button class="btn btn-primary" onclick="generateSchedule()">
        <i class="bi bi-arrow-repeat"></i> üî• Recalcular Programaci√≥n con IA
    </button>
</div>

<div id="loading" style="display: none; margin-top: 2rem; text-align: center;">
    <div class="spinner"
        style="border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;">
    </div>
    <p style="margin-top: 1rem; color: #38BDF8;">ü§ñ IA analizando backlog y capacidades...</p>
</div>

<div id="results" style="margin-top: 2rem;">
    <div class="card glass" style="text-align: center; padding: 3rem;">
        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #1E293B;"></i>
        <p style="color: #94A3B8; margin-top: 1rem;">A√∫n no se ha generado una programaci√≥n din√°mica para este periodo.
        </p>
    </div>
</div>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-top: 2rem;
        background: rgba(0, 0, 0, 0.2);
        padding: 1rem;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
    let currentPlan = null;
    let mainChart = null;

    async function generateSchedule() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').innerHTML = '';

        try {
            const response = await fetch('/api/generate_schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            document.getElementById('loading').style.display = 'none';

            if (!response.ok || data.error) {
                const errorMsg = data.error || `Error del servidor (${response.status})`;
                document.getElementById('results').innerHTML = `
                    <div class="card glass" style="border-left: 4px solid ##EF4444;">
                        <h3 style="color: #EF4444;">‚ùå Error de Programaci√≥n</h3>
                        <p style="margin-top: 1rem;">${errorMsg}</p>
                        ${data.traceback ? `<pre style="font-size: 0.7rem; color: #94A3B8; margin-top: 1rem; background: rgba(0,0,0,0.3); padding: 1rem; overflow: auto;">${data.traceback.join('\n')}</pre>` : ''}
                    </div>
                `;
                return;
            }

            const scenario = data.scenario;
            currentPlan = scenario;
            const res = scenario.resumen_global;

            let html = `
            <div class="card glass" style="border-top: 4px solid #10B981; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h3 style="color: #10B981;">‚úÖ Programaci√≥n Exitosa</h3>
                        <p style="margin-top:0.5rem; color: #94A3B8;">${res.comentario_estrategia}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="savePlan()" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                            <i class="bi bi-save"></i> Guardar Plan
                        </button>
                        <button class="btn btn-primary" onclick="exportToPDF()" style="padding: 0.5rem 1rem; font-size: 0.8rem; background: #3B82F6;">
                            <i class="bi bi-file-earmark-pdf"></i> PDF
                        </button>
                    </div>
                </div>
                <div class="grid" style="margin-top: 2rem;">
                    <div class="card" style="background: rgba(0,0,0,0.2);">
                        <div class="metric-label">Fin Estimado</div>
                        <div class="metric-value" style="font-size: 1.2rem;">${res.fecha_finalizacion_total}</div>
                    </div>
                    <div class="card" style="background: rgba(0,0,0,0.2);">
                        <div class="metric-label">D√≠as Programados</div>
                        <div class="metric-value" style="font-size: 1.2rem;">${res.total_dias_programados}</div>
                    </div>
                    <div class="card" style="background: rgba(0,0,0,0.2);">
                        <div class="metric-label">Total Kg en el Plan</div>
                        <div class="metric-value" style="font-size: 1.2rem; color: #10B981;">${res.kg_totales_plan?.toLocaleString() || '0'} kg</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="resourceChart"></canvas>
                </div>
            </div>

            <h2 style="margin: 2rem 0 1rem;">üèóÔ∏è Requerimientos de Materia Prima (Extrusi√≥n)</h2>
            <div class="card glass" style="margin-bottom: 2rem; border-left: 4px solid #FACC15;">
                <p style="margin-bottom: 1rem; font-size: 0.9rem; color: #94A3B8;">Detalle diario de kilos por referencia requeridos para abastecer la l√≠nea de torsi√≥n.</p>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead>
                            <tr style="color: #FACC15; border-bottom: 1px solid rgba(250, 204, 21, 0.2);">
                                <th style="padding: 0.75rem;">Fecha</th>
                                <th style="padding: 0.75rem;">Referencia</th>
                                <th style="padding: 0.75rem;">Cantidad Requerida</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            scenario.cronograma_diario.forEach(dia => {
                if (dia.requerimiento_abastecimiento && dia.requerimiento_abastecimiento.balance_por_referencia) {
                    dia.requerimiento_abastecimiento.balance_por_referencia.forEach((b, idx) => {
                        html += `
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <td style="padding: 0.75rem;">${idx === 0 ? `<strong>${dia.fecha}</strong>` : ''}</td>
                                <td style="padding: 0.75rem;">${b.referencia}</td>
                                <td style="padding: 0.75rem; font-weight: 700; color: #10B981;">${Math.round(b.kg_suministro).toLocaleString()} kg</td>
                            </tr>
                        `;
                    });
                }
            });

            html += `
                        </tbody>
                    </table>
                </div>
            </div>

            <h2 style="margin: 2rem 0 1rem;">üèÅ Resumen por Referencia (Terminaci√≥n)</h2>
            <div class="card glass" style="margin-bottom: 2rem; border-left: 4px solid #38BDF8;">
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="color: #38BDF8; border-bottom: 1px solid rgba(56, 189, 248, 0.2);">
                            <th style="padding: 0.75rem;">Referencia</th>
                            <th style="padding: 0.75rem;">Fecha Finalizaci√≥n</th>
                            <th style="padding: 0.75rem;">Asignaci√≥n Puestos</th>
                            <th style="padding: 0.75rem;">Total Kg</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            scenario.tabla_finalizacion_referencias.forEach(row => {
                html += `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 0.75rem;">${row.referencia}</td>
                        <td style="padding: 0.75rem;">${row.fecha_finalizacion}</td>
                        <td style="padding: 0.75rem;">${row.puestos_promedio}</td>
                        <td style="padding: 0.75rem;">${row.kg_totales.toLocaleString()} kg</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;

            // Daily Detailed Card
            html += `<h2 style="margin: 2.5rem 0 1.5rem;">üìÖ Cronograma Detallado D√≠a a D√≠a</h2>`;

            scenario.cronograma_diario.forEach(dia => {
                html += `
                <div class="card glass" style="margin-bottom: 2.5rem; border-bottom: 2px solid var(--accent-blue);">
                    <h3 style="background: rgba(56, 189, 248, 0.1); padding: 0.5rem 1rem; border-radius: 4px; border-left: 4px solid var(--accent-blue); margin-bottom: 1.5rem;">
                        üìÖ D√≠a: ${dia.fecha}
                    </h3>

                    <!-- Rewinder Table -->
                    <h4 style="color: var(--accent-blue); margin-bottom: 0.75rem;"><i class="bi bi-gear-wide-connected"></i> Programaci√≥n de Rebobinado (Rewinder)</h4>
                    <div style="overflow-x: auto; margin-bottom: 1.5rem;">
                        <table style="width: 100%; border-collapse: collapse; text-align: left;">
                            <thead style="background: rgba(0,0,0,0.3);">
                                <tr style="color: #38BDF8; border-bottom: 1px solid var(--border-color);">
                                    <th style="padding: 0.5rem;">#</th>
                                    <th style="padding: 0.5rem;">Referencia</th>
                                    <th style="padding: 0.5rem;">Inicio</th>
                                    <th style="padding: 0.5rem;">Fin</th>
                                    <th style="padding: 0.5rem;">Puestos</th>
                                    <th style="padding: 0.5rem;">Operarios</th>
                                    <th style="padding: 0.5rem;">Kg Prod.</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                dia.turnos_asignados.forEach(sec => {
                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 0.5rem;">${sec.orden_secuencia}</td>
                            <td style="padding: 0.5rem; color: #FFF;">${sec.referencia}</td>
                            <td style="padding: 0.5rem;">${sec.hora_inicio}</td>
                            <td style="padding: 0.5rem;">${sec.hora_fin}</td>
                            <td style="padding: 0.5rem;">${sec.puestos_utilizados}</td>
                            <td style="padding: 0.5rem;">${sec.operarios_calculados}</td>
                            <td style="padding: 0.5rem; font-weight: bold; color: #10B981;">${sec.kg_producidos.toLocaleString()}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;

                // Torsion Table
                if (dia.requerimiento_abastecimiento) {
                    html += `
                        <div style="background: rgba(0,0,0,0.2); padding: 1.25rem; border-radius: 8px;">
                            <h4 style="color: #FACC15; margin-bottom: 0.75rem;"><i class="bi bi-link-45deg"></i> Requerimiento de Suministro (Torsi√≥n)</h4>
                            <p style="font-size: 0.9rem; color: #94A3B8; margin-bottom: 1rem;">
                                Kg Totales: <strong>${dia.requerimiento_abastecimiento.kg_totales_demandados.toLocaleString()} kg</strong> | 
                                Horas Prod.: <strong>${dia.requerimiento_abastecimiento.horas_produccion_conjunta}h</strong>
                            </p>
                            
                            <!-- Daily Balance Table -->
                            <div style="overflow-x: auto; margin-bottom: 1rem;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="color: #CCC; border-bottom: 1px solid #444;">
                                            <th style="padding: 0.4rem;">Referencia</th>
                                            <th style="padding: 0.4rem;">Suministro</th>
                                            <th style="padding: 0.4rem;">Consumo</th>
                                            <th style="padding: 0.4rem;">Balance</th>
                                            <th style="padding: 0.4rem;">Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    dia.requerimiento_abastecimiento.balance_por_referencia.forEach(b => {
                        const color = b.status === 'OK' ? '#10B981' : (b.status === 'EXCESO' ? '#FACC15' : '#EF4444');
                        html += `
                            <tr style="border-bottom: 1px solid #333;">
                                <td style="padding: 0.4rem;">${b.referencia}</td>
                                <td style="padding: 0.4rem;">${b.kg_suministro.toLocaleString()} kg</td>
                                <td style="padding: 0.4rem;">${b.kg_consumo.toLocaleString()} kg</td>
                                <td style="padding: 0.4rem;">${b.balance.toLocaleString()} kg</td>
                                <td style="padding: 0.4rem; color: ${color}; font-weight: bold;">${b.status}</td>
                            </tr>
                        `;
                    });

                    html += `</tbody></table></div>`;

                    html += `
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
                                ${dia.requerimiento_abastecimiento.detalle_torcedoras.map(m => `
                                    <span style="background: rgba(250, 204, 21, 0.1); border: 1px solid rgba(250, 204, 21, 0.3); color: #FACC15; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                        <strong>${m.maquina}</strong>: ${m.ref} (${m.horas}h)
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `</div>`;
            });

            html += `
            <h2 style="margin: 2rem 0 1rem;">üìä Gr√°fica de Kg Totales Diarios</h2>
            <div class="card glass" style="margin-bottom: 2rem;">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="dailyTotalsChart"></canvas>
                </div>
            </div>
            `;

            document.getElementById('results').innerHTML = html;

            // Render Charts
            if (scenario.datos_para_grafica) {
                renderChart(scenario.datos_para_grafica);
                renderDailyTotalsChart(scenario.datos_para_grafica);
            }

        } catch (err) {
            document.getElementById('loading').style.display = 'none';
            alert("Error al conectar con la IA de programaci√≥n.");
        }
    }

    function renderDailyTotalsChart(data) {
        const ctx = document.getElementById('dailyTotalsChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Kg Totales x D√≠a',
                    data: data.dataset_kg_produccion,
                    backgroundColor: 'rgba(16, 185, 129, 0.5)',
                    borderColor: '#10B981',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { color: '#94A3B8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { ticks: { color: '#94A3B8' }, grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function renderChart(data) {
        const ctx = document.getElementById('resourceChart').getContext('2d');
        if (mainChart) mainChart.destroy();

        mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Operarios Rewinder',
                        data: data.dataset_operarios,
                        borderColor: '#38BDF8',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Producci√≥n Diaria (Kg)',
                        data: data.dataset_kg_produccion,
                        borderColor: '#10B981',
                        borderDash: [5, 5],
                        yAxisID: 'y1',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Operarios', color: '#94A3B8' },
                        ticks: { color: '#94A3B8' },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Kg Producidos', color: '#10B981' },
                        ticks: { color: '#10B981' },
                        grid: { drawOnChartArea: false }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#94A3B8' } }
                }
            }
        });
    }

    async function savePlan() {
        if (!currentPlan) return;

        try {
            const response = await fetch('/api/save_schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: `Plan ${new Date().toLocaleDateString()}`, plan: currentPlan })
            });
            const res = await response.json();
            if (res.success) alert("‚úÖ Plan guardado exitosamente");
            else alert("‚ùå Error: " + res.error);
        } catch (err) {
            alert("‚ùå Error de red");
        }
    }

    function exportToPDF() {
        if (!currentPlan) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');

        // Header
        doc.setFontSize(18);
        doc.setTextColor(40);
        doc.text("Plan de Producci√≥n Industrial - Ciplas", 40, 40);

        doc.setFontSize(10);
        doc.text(`Generado: ${new Date().toLocaleString()}`, 40, 60);
        doc.text(`Fin Total Estimado: ${currentPlan.resumen_global.fecha_finalizacion_total}`, 40, 75);
        doc.text(`Total Kg Planificados: ${currentPlan.resumen_global.kg_totales_plan.toLocaleString()} kg`, 40, 90);
        doc.text(`Estrategia: ${currentPlan.resumen_global.comentario_estrategia}`, 40, 105);

        // Raw Materials Table
        doc.setFontSize(14);
        doc.text("Requerimientos de Materia Prima (Extrusi√≥n)", 40, 140);
        
        const rawMaterialsData = [];
        currentPlan.cronograma_diario.forEach(dia => {
            if (dia.requerimiento_abastecimiento && dia.requerimiento_abastecimiento.balance_por_referencia) {
                dia.requerimiento_abastecimiento.balance_por_referencia.forEach((b, idx) => {
                    rawMaterialsData.push([
                        idx === 0 ? dia.fecha : '',
                        b.referencia,
                        Math.round(b.kg_suministro).toLocaleString() + " kg"
                    ]);
                });
            }
        });

        doc.autoTable({
            startY: 150,
            head: [['Fecha', 'Referencia', 'Kg Requeridos']],
            body: rawMaterialsData,
            theme: 'grid',
            headStyles: { fillColor: [250, 204, 21], textColor: [0, 0, 0] }
        });

        doc.addPage();
        let lastY = 40;

        // Summary Table
        doc.setFontSize(14);
        doc.text("Resumen de Finalizaci√≥n por Referencia", 40, lastY);

        const summaryData = currentPlan.tabla_finalizacion_referencias.map(r => [
            r.referencia, r.fecha_finalizacion, r.puestos_promedio, Math.round(r.kg_totales).toLocaleString() + " kg"
        ]);

        doc.autoTable({
            startY: lastY + 10,
            head: [['Referencia', 'Finalizaci√≥n', 'Puestos Prom.', 'Kg Totales']],
            body: summaryData,
            theme: 'grid',
            headStyles: { fillColor: [56, 189, 248] }
        });

        // Loop Days
        lastY = doc.lastAutoTable.finalY + 30;

        currentPlan.cronograma_diario.forEach((dia, index) => {
            if (lastY > 700) { doc.addPage(); lastY = 40; }
            
            doc.setFontSize(12);
            doc.setTextColor(56, 189, 248);
            doc.text(`D√≠a: ${dia.fecha}`, 40, lastY);
            lastY += 20;

            // Rewinder Sub-table
            const rwData = dia.turnos_asignados.map(t => [
                t.orden_secuencia, t.referencia, t.hora_inicio, t.hora_fin, t.puestos_utilizados, t.operarios_calculados, t.kg_producidos.toLocaleString()
            ]);
            doc.autoTable({
                startY: lastY,
                head: [['#', 'Ref', 'Inicio', 'Fin', 'Puestos', 'Ops', 'Kg']],
                body: rwData,
                theme: 'striped',
                margin: { left: 40 },
                styles: { fontSize: 8 }
            });

            lastY = doc.lastAutoTable.finalY + 15;

            // Balance Sub-table
            if (dia.requerimiento_abastecimiento && dia.requerimiento_abastecimiento.balance_por_referencia) {
                const balData = dia.requerimiento_abastecimiento.balance_por_referencia.map(b => [
                    b.referencia, b.kg_suministro.toLocaleString(), b.kg_consumo.toLocaleString(), b.balance.toLocaleString(), b.status
                ]);
                doc.autoTable({
                    startY: lastY,
                    head: [['Referencia', 'Suministro (kg)', 'Consumo (kg)', 'Balance (kg)', 'Estado']],
                    body: balData,
                    theme: 'grid',
                    margin: { left: 60 },
                    styles: { fontSize: 7 },
                    headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0] }
                });
                lastY = doc.lastAutoTable.finalY + 30;
            }
        });

        doc.save(`Plan_Produccion_Ciplas_${new Date().toISOString().split('T')[0]}.pdf`);
    }
</script>

<style>
    .grid-metrics {
        margin-top: 1rem;
    }
    .metric-label {
        font-size: 0.8rem;
        color: #94A3B8;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .metric-value {
        font-weight: 700;
        letter-spacing: -0.5px;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-top: 2rem;
    }
</style>
{% endblock %}
