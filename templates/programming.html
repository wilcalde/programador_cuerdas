{% extends "base.html" %}

{% block header_title %}üìÖ Programaci√≥n de Producci√≥n{% endblock %}

{% block content %}
<div class="card glass" style="border-left: 4px solid var(--accent-blue);">
    <p>üí° La programaci√≥n es generada por IA bas√°ndose en el backlog y la capacidad de los 28 puestos de Rewinder
        disponible.</p>
</div>

<div style="margin-top: 2rem; display: flex; gap: 1rem;">
    <button class="btn btn-primary" onclick="generateSchedule()">
        <i class="bi bi-arrow-repeat"></i> üî• Recalcular Programaci√≥n con IA
    </button>
</div>

<div id="loading" style="display: none; margin-top: 2rem; text-align: center;">
    <div class="spinner"
        style="border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;">
    </div>
    <p style="margin-top: 1rem; color: #38BDF8;">ü§ñ IA analizando backlog y capacidades...</p>
</div>

<div id="results" style="margin-top: 2rem;">
    <div class="card glass" style="text-align: center; padding: 3rem;">
        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #1E293B;"></i>
        <p style="color: #94A3B8; margin-top: 1rem;">A√∫n no se ha generado una programaci√≥n din√°mica para este periodo.
        </p>
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    async function generateSchedule() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').innerHTML = '';

        try {
            const response = await fetch('/api/generate_schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const data = await response.json();

            document.getElementById('loading').style.display = 'none';

            if (data.error) {
                document.getElementById('results').innerHTML = `
                    <div class="card glass" style="border-left: 4px solid #EF4444;">
                        <h3 style="color: #EF4444;">‚ùå Error</h3>
                        <p style="margin-top: 1rem;">${data.error}</p>
                    </div>
                `;
                return;
            }

            const scenario = data.scenario;
            const res = scenario.resumen_ejecutivo;

            let html = `
            <div class="card glass" style="border-top: 4px solid #10B981; margin-bottom: 2rem;">
                <h3 style="color: #10B981;">‚úÖ Programaci√≥n Exitosa</h3>
                <p style="margin-top:0.5rem; color: #94A3B8;">Optimizado por IA - Balance de Flujo Continuo</p>
                <div class="grid" style="margin-top: 2rem;">
                    <div class="card" style="background: rgba(0,0,0,0.2);">
                        <div class="metric-label">Fin Estimado</div>
                        <div class="metric-value" style="font-size: 1.2rem;">${res.makespan_fecha_hora_final}</div>
                    </div>
                    <div class="card" style="background: rgba(0,0,0,0.2);">
                        <div class="metric-label">Total Producido</div>
                        <div class="metric-value" style="font-size: 1.2rem;">${res.total_kg_producidos} kg</div>
                    </div>
                    <div class="card" style="background: rgba(0,0,0,0.2);">
                        <div class="metric-label">Eficiencia Flujo</div>
                        <div class="metric-value" style="font-size: 1.2rem;">${res.eficiencia_flujo}</div>
                    </div>
                </div>
            </div>

            <h2 style="margin: 2rem 0 1rem;">üìã Cronograma Detallado</h2>
            `;

            scenario.cronograma_diario.forEach(dia => {
                html += `
                <div class="card glass" style="margin-bottom: 1.5rem;">
                    <h3 style="border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem;">
                        üìÖ ${dia.dia_calendario} (${dia.horas_disponibles}h)
                    </h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; text-align: left;">
                            <thead>
                                <tr style="color: var(--accent-blue); border-bottom: 1px solid var(--border-color);">
                                    <th style="padding: 0.5rem;">Bloque</th>
                                    <th style="padding: 0.5rem;">Referencia</th>
                                    <th style="padding: 0.5rem;">Inicio</th>
                                    <th style="padding: 0.5rem;">Fin</th>
                                    <th style="padding: 0.5rem;">Puestos</th>
                                    <th style="padding: 0.5rem;">Kg</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                dia.bloques_asignacion.forEach(b => {
                    html += `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 0.75rem;">${b.bloque_numero}</td>
                            <td style="padding: 0.75rem;"><strong>${b.referencia}</strong></td>
                            <td style="padding: 0.75rem;">${b.hora_inicio_dia}</td>
                            <td style="padding: 0.75rem;">${b.hora_fin_dia}</td>
                            <td style="padding: 0.75rem;">${b.puestos_rebobinado}</td>
                            <td style="padding: 0.75rem;">${Math.round(b.kg_producidos_bloque)} kg</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                `;
            });

            document.getElementById('results').innerHTML = html;

        } catch (err) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').innerHTML = `
                <div class="card glass" style="border-left: 4px solid #EF4444;">
                    <h3 style="color: #EF4444;">‚ùå Error de Red</h3>
                    <p style="margin-top: 1rem;">No se pudo conectar con el servidor.</p>
                </div>
            `;
        }
    }
</script>
{% endblock %}
