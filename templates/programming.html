{% extends "base.html" %}

{% block header_title %}üìÖ Programaci√≥n de Producci√≥n{% endblock %}

{% block content %}
<div class="card glass" style="border-left: 4px solid var(--accent-blue);">
    <p>üí° La programaci√≥n es generada por IA bas√°ndose en el backlog y la capacidad de los 28 puestos de Rewinder
        disponible.</p>
</div>

<div
    style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color);">
    <div style="display: flex; gap: 2rem; align-items: center;">
        <span style="font-weight: 600; color: #94A3B8;">Criterio de Optimizaci√≥n:</span>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #F8FAFC;">
            <input type="radio" name="strategy" value="kg" checked style="accent-color: var(--accent-blue);">
            Maximizar Kg
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #F8FAFC;">
            <input type="radio" name="strategy" value="priority" style="accent-color: var(--accent-blue);">
            Prioridades Primero ‚≠ê
        </label>
    </div>
    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
        <button class="btn btn-primary" onclick="generateSchedule()" style="min-width: 250px; font-weight: 700;">
            <i class="bi bi-magic"></i> Generar programaci√≥n
        </button>
    </div>
</div>

<div id="loading" style="display: none; margin-top: 2rem; text-align: center;">
    <div class="spinner"
        style="border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;">
    </div>
    <p style="margin-top: 1rem; color: #38BDF8;">ü§ñ IA analizando backlog y capacidades...</p>
</div>

<div id="results" style="margin-top: 2rem;">
    <div class="card glass" style="text-align: center; padding: 3rem;">
        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #1E293B;"></i>
        <p style="color: #94A3B8; margin-top: 1rem;">A√∫n no se ha generado una programaci√≥n din√°mica para este periodo.
        </p>
    </div>
</div>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-top: 2rem;
        background: rgba(0, 0, 0, 0.2);
        padding: 1rem;
        border-radius: 8px;
    }

    .schedule-tabs {
        display: flex;
        gap: 0;
        margin: 2rem 0 1.5rem;
        border-bottom: 2px solid var(--border-color);
    }

    .schedule-tab {
        padding: 0.75rem 2rem;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        color: #94A3B8;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
        user-select: none;
    }

    .schedule-tab:hover {
        color: #F8FAFC;
    }

    .schedule-tab.active {
        color: #38BDF8;
        border-bottom-color: #38BDF8;
    }

    .schedule-tab.torsion-tab.active {
        color: #A78BFA;
        border-bottom-color: #A78BFA;
    }

    .tab-panel {
        display: none;
    }

    .tab-panel.active {
        display: block;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
    let currentPlan = null;
    let mainChart = null;
    let dailyChart = null;

    async function generateSchedule() {
        const strategy = document.querySelector('input[name="strategy"]:checked').value;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').innerHTML = '';

        try {
            const response = await fetch('/api/generate_schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ strategy: strategy })
            });
            const data = await response.json();

            document.getElementById('loading').style.display = 'none';

            if (!response.ok || data.error) {
                const errorMsg = data.error || `Error del servidor (${response.status})`;
                document.getElementById('results').innerHTML = `
                    <div class="card glass" style="border-left: 4px solid #EF4444;">
                        <h3 style="color: #EF4444;">‚ùå Error de Programaci√≥n</h3>
                        <p style="margin-top: 1rem;">${errorMsg}</p>
                        ${data.traceback ? `<pre style="font-size: 0.7rem; color: #94A3B8; margin-top: 1rem; background: rgba(0,0,0,0.3); padding: 1rem; overflow: auto;">${data.traceback.join('\n')}</pre>` : ''}
                    </div>
                `;
                return;
            }

            const scenario = data.scenario;
            currentPlan = scenario;
            const res = scenario.resumen_global;

            let html = `
            <div class="card glass" style="border-top: 4px solid #10B981; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h3 style="color: #10B981;">‚úÖ Programaci√≥n Exitosa</h3>
                        <p style="margin-top:0.5rem; color: #94A3B8;">${res.comentario_estrategia}</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="savePlan()" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                            <i class="bi bi-save"></i> Guardar Plan
                        </button>
                        <button class="btn btn-primary" onclick="exportToPDF()" style="padding: 0.5rem 1rem; font-size: 0.8rem; background: #3B82F6;">
                            <i class="bi bi-file-earmark-pdf"></i> PDF
                        </button>
                    </div>
                </div>
                <div class="grid" style="margin-top: 2rem;">
                    <div class="card" style="background: rgba(0,0,0,0.2);">
                        <div class="metric-label">Fin Estimado</div>
                        <div class="metric-value" style="font-size: 1.2rem;">${res.fecha_finalizacion_total}</div>
                    </div>
                    <div class="card" style="background: rgba(0,0,0,0.2);">
                        <div class="metric-label">D√≠as Programados</div>
                        <div class="metric-value" style="font-size: 1.2rem;">${res.total_dias_programados}</div>
                    </div>
                    <div class="card" style="background: rgba(0,0,0,0.2);">
                        <div class="metric-label">Total Kg en el Plan</div>
                        <div class="metric-value" style="font-size: 1.2rem; color: #10B981;">${res.kg_totales_plan?.toLocaleString() || '0'} kg</div>
                    </div>
                    <div class="card" style="background: rgba(0,0,0,0.2);">
                        <div class="metric-label">28 Rewinders Hasta</div>
                        <div class="metric-value" style="font-size: 1.2rem; color: #FACC15;">${res.fecha_capacidad_completa || 'N/A'}</div>
                    </div>
                </div>

                ${res.alerta_capacidad ? `
                <div style="margin-top: 1.5rem; padding: 1rem 1.5rem; border-radius: 8px; border-left: 4px solid ${res.alerta_capacidad.startsWith('‚úÖ') ? '#10B981' : '#FACC15'}; background: ${res.alerta_capacidad.startsWith('‚úÖ') ? 'rgba(16,185,129,0.1)' : 'rgba(250,204,21,0.1)'}; font-size: 0.95rem;">
                    <strong style="color: ${res.alerta_capacidad.startsWith('‚úÖ') ? '#10B981' : '#FACC15'};">Alerta de Capacidad:</strong>
                    <span style="color: #F8FAFC; margin-left: 0.5rem;">${res.alerta_capacidad}</span>
                </div>
                ` : ''}
                
                <div class="chart-container">
                    <canvas id="resourceChart"></canvas>
                </div>
            </div>

            `;

            // ============== SUMMARY TABLE ==============
            html += `
            <h2 style="margin: 2rem 0 1rem;">üèÅ Resumen por Referencia (Terminaci√≥n)</h2>
            <div class="card glass" style="margin-bottom: 2rem; border-left: 4px solid #38BDF8;">
                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                    <thead>
                        <tr style="color: #38BDF8; border-bottom: 1px solid var(--border-color);">
                            <th style="padding: 0.75rem;">Referencia</th>
                            <th style="padding: 0.75rem;">Descripci√≥n</th>
                            <th style="padding: 0.75rem;">Fecha de Terminaci√≥n</th>
                            <th style="padding: 0.75rem;">Puestos Promedio</th>
                            <th style="padding: 0.75rem;">Total Kg</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            scenario.tabla_finalizacion_referencias.forEach(row => {
                html += `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 0.75rem;"><strong>${row.referencia}</strong></td>
                        <td style="padding: 0.75rem; font-size: 0.85rem; color: #CBD5E1;">${row.descripcion || ''}</td>
                        <td style="padding: 0.75rem; color: #10B981;">üìÖ ${row.fecha_finalizacion}</td>
                        <td style="padding: 0.75rem;">${row.puestos_promedio}</td>
                        <td style="padding: 0.75rem;">${Math.round(row.kg_totales)} kg</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            </div>
            `;

            // ============== TAB NAVIGATION ==============
            html += `
            <div class="schedule-tabs">
                <div class="schedule-tab active" onclick="switchScheduleTab('rewinder', this)">üîÑ Rewinder</div>
                <div class="schedule-tab torsion-tab" onclick="switchScheduleTab('torsion', this)">‚öôÔ∏è Torsi√≥n</div>
            </div>
            `;

            // ============== REWINDER TAB ==============
            html += `<div id="panel-rewinder" class="tab-panel active">`;
            html += `<h2 style="margin: 1rem 0;">üìã Cronograma Diario ‚Äî Rewinder</h2>`;

            scenario.cronograma_diario.forEach(dia => {
                html += `
                <div class="card glass" style="margin-bottom: 2.5rem; border-bottom: 2px solid var(--accent-blue);">
                    <h3 style="background: rgba(56, 189, 248, 0.1); padding: 0.5rem 1rem; border-radius: 4px; border-left: 4px solid var(--accent-blue); margin-bottom: 1.5rem;">
                        üìÖ D√≠a: ${dia.fecha}
                    </h3>
                `;

                if (dia.turnos && dia.turnos.length > 0) {
                    dia.turnos.forEach(turno => {
                        const shiftColors = { 'A': '#38BDF8', 'B': '#A78BFA', 'C': '#FB923C' };
                        const shiftColor = shiftColors[turno.nombre] || '#38BDF8';

                        html += `
                        <div style="margin-bottom: 1.5rem; border: 1px solid ${shiftColor}33; border-radius: 8px; overflow: hidden;">
                            <div style="background: ${shiftColor}15; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid ${shiftColor}33;">
                                <div>
                                    <span style="font-weight: 700; font-size: 1.1rem; color: ${shiftColor};">üîÑ Turno ${turno.nombre}</span>
                                    <span style="color: #94A3B8; margin-left: 1rem; font-size: 0.9rem;">${turno.horario}</span>
                                </div>
                                <div style="display: flex; gap: 1.5rem; align-items: center;">
                                    <span style="color: #94A3B8; font-size: 0.85rem;">
                                        üë∑ <strong style="color: ${shiftColor};">${turno.operarios_requeridos}</strong> Operario(s)
                                    </span>
                                    <span style="color: #94A3B8; font-size: 0.85rem;">
                                        ‚è±Ô∏è <strong style="color: ${shiftColor};">8h</strong> continuas
                                    </span>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                                    <thead style="background: rgba(0,0,0,0.3);">
                                        <tr style="color: ${shiftColor}; border-bottom: 1px solid var(--border-color);">
                                            <th style="padding: 0.5rem;">Referencia</th>
                                            <th style="padding: 0.5rem;">Descripci√≥n</th>
                                            <th style="padding: 0.5rem;">Puestos</th>
                                            <th style="padding: 0.5rem;">Operarios</th>
                                            <th style="padding: 0.5rem;">Producci√≥n (8h)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        turno.asignaciones.forEach(a => {
                            html += `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.75rem;"><strong>${a.referencia}</strong></td>
                                    <td style="padding: 0.75rem; font-size: 0.85rem; color: #CBD5E1;">${a.descripcion || ''}</td>
                                    <td style="padding: 0.75rem; font-weight: 700; color: ${shiftColor};">${a.puestos}</td>
                                    <td style="padding: 0.75rem;">${a.operarios}</td>
                                    <td style="padding: 0.75rem; font-weight: 700; color: #10B981;">${Math.round(a.kg_producidos)} kg</td>
                                </tr>
                            `;
                        });

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        `;
                    });
                } else {
                    html += `<p style="color: #94A3B8; padding: 1rem;">Sin producci√≥n programada para este d√≠a.</p>`;
                }

                if (dia.debug_info) {
                    html += `
                    <div style="margin: 0 1rem 1.5rem 1rem; padding: 1.25rem; background: rgba(0,0,0,0.4); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                        <h4 style="color: #38BDF8; font-size: 0.95rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.6rem; font-weight: 700;">
                            <i class="bi bi-calculator-fill"></i> C√°lculos de Capacidad y Balance
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                            <!-- Torsion Balance -->
                            <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px;">
                                <div style="color: #94A3B8; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.8rem; font-weight: 700;">Balance Torsi√≥n (Kg/h)</div>
                                ${dia.debug_info.balance_torsion.map(b => `
                                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 0.4rem;">
                                        <span style="color: #CBD5E1;">Denier ${b.denier}</span>
                                        <span style="color: ${b.porcentaje > 90 ? '#EF4444' : '#10B981'}; font-weight: 600;">
                                            ${b.ocupacion_kgh} / ${b.capacidad_total_kgh} (${b.porcentaje}%)
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                            <!-- Rewinder Occupancy -->
                            <div style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 8px; border-left: 3px solid #38BDF8;">
                                <div style="color: #94A3B8; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.8rem; font-weight: 700;">Ocupaci√≥n Rewinder</div>
                                <div style="display: flex; align-items: center; gap: 1.2rem;">
                                    <div style="font-size: 2rem; font-weight: 800; color: #F8FAFC;">${dia.debug_info.ocupacion_rewinder_avg}</div>
                                    <div style="font-size: 0.75rem; color: ${dia.debug_info.puestos_libres_promedio > 0 ? '#FB923C' : '#10B981'}; font-weight: 600;">
                                        ${dia.debug_info.puestos_libres_promedio > 0 ? `‚ö†Ô∏è ${dia.debug_info.puestos_libres_promedio} puestos libres` : '‚úÖ Capacidad Completa'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }

                html += `</div>`;
            });

            html += `
            <h2 style="margin: 2rem 0 1rem;">üìä Gr√°fica de Kg Totales Diarios</h2>
            <div class="card glass" style="margin-bottom: 2rem;">
                <div class="chart-container" style="height: 250px;">
                    <canvas id="dailyTotalsChart"></canvas>
                </div>
            </div>
            `;
            html += `</div>`; // close panel-rewinder

            // ============== TORSION TAB ==============
            html += `<div id="panel-torsion" class="tab-panel">`;
            html += `
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 1rem 0;">
                <h2>‚öôÔ∏è Cronograma Diario ‚Äî L√≠nea de Torsi√≥n</h2>
                <button class="btn btn-primary" onclick="exportTorsionPDF()" style="padding: 0.5rem 1rem; font-size: 0.8rem; background: #7C3AED;">
                    <i class="bi bi-file-earmark-pdf"></i> PDF Torsi√≥n
                </button>
            </div>
            `;

            scenario.cronograma_diario.forEach(dia => {
                const torsionTurnos = dia.turnos_torsion || [];

                html += `
                <div class="card glass" style="margin-bottom: 2.5rem; border-bottom: 2px solid #A78BFA;">
                    <h3 style="background: rgba(167, 139, 250, 0.1); padding: 0.5rem 1rem; border-radius: 4px; border-left: 4px solid #A78BFA; margin-bottom: 1.5rem;">
                        üìÖ D√≠a: ${dia.fecha}
                    </h3>
                `;

                if (torsionTurnos.length > 0) {
                    torsionTurnos.forEach(turno => {
                        const shiftColors = { 'A': '#38BDF8', 'B': '#A78BFA', 'C': '#FB923C' };
                        const shiftColor = shiftColors[turno.nombre] || '#A78BFA';

                        html += `
                        <div style="margin-bottom: 1.5rem; border: 1px solid ${shiftColor}33; border-radius: 8px; overflow: hidden;">
                            <div style="background: ${shiftColor}15; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid ${shiftColor}33;">
                                <div>
                                    <span style="font-weight: 700; font-size: 1.1rem; color: ${shiftColor};">‚öôÔ∏è Turno ${turno.nombre}</span>
                                    <span style="color: #94A3B8; margin-left: 1rem; font-size: 0.9rem;">${turno.horario}</span>
                                </div>
                                <div style="display: flex; gap: 1.5rem; align-items: center;">
                                    <span style="color: #94A3B8; font-size: 0.85rem;">
                                        üë∑ <strong style="color: ${shiftColor};">${turno.operarios_requeridos}</strong> Operario(s)
                                    </span>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table style="width: 100%; border-collapse: collapse; text-align: left;">
                                    <thead style="background: rgba(0,0,0,0.3);">
                                        <tr style="color: ${shiftColor}; border-bottom: 1px solid var(--border-color);">
                                            <th style="padding: 0.5rem;">M√°quina</th>
                                            <th style="padding: 0.5rem;">Referencia</th>
                                            <th style="padding: 0.5rem;">Denier</th>
                                            <th style="padding: 0.5rem;">Husos</th>
                                            <th style="padding: 0.5rem;">Kg/h M√°q.</th>
                                            <th style="padding: 0.5rem;">Producci√≥n (8h)</th>
                                            <th style="padding: 0.5rem;">Operarios</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        turno.asignaciones.forEach(a => {
                            const utilizacion = a.husos_totales > 0 ? Math.round((a.husos_asignados / a.husos_totales) * 100) : 0;
                            const utilizColor = utilizacion >= 80 ? '#10B981' : (utilizacion >= 50 ? '#FACC15' : '#EF4444');
                            html += `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 0.75rem; font-weight: 700; color: #A78BFA;">${a.maquina}</td>
                                    <td style="padding: 0.75rem;"><strong>${a.referencia}</strong></td>
                                    <td style="padding: 0.75rem; color: #94A3B8;">${a.denier}</td>
                                    <td style="padding: 0.75rem;">
                                        <span style="font-weight: 700; color: ${shiftColor};">${a.husos_asignados}</span>
                                        <span style="color: #64748B;">/ ${a.husos_totales}</span>
                                        <span style="margin-left: 0.5rem; font-size: 0.75rem; color: ${utilizColor}; font-weight: 600;">(${utilizacion}%)</span>
                                    </td>
                                    <td style="padding: 0.75rem; color: #94A3B8;">${a.kgh_maquina}</td>
                                    <td style="padding: 0.75rem; font-weight: 700; color: #10B981;">${Math.round(a.kg_turno)} kg</td>
                                    <td style="padding: 0.75rem;">${a.operarios}</td>
                                </tr>
                            `;
                        });

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        `;
                    });
                } else {
                    html += `<p style="color: #94A3B8; padding: 1rem;">Sin asignaci√≥n de torsi√≥n para este d√≠a.</p>`;
                }

                html += `</div>`;
            });

            html += `</div>`; // close panel-torsion

            document.getElementById('results').innerHTML = html;

            // Render Charts
            if (scenario.datos_para_grafica) {
                renderChart(scenario.datos_para_grafica);
                renderDailyTotalsChart(scenario.datos_para_grafica);
            }

        } catch (err) {
            console.error("Schedule generation error:", err);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').innerHTML = `
                <div class="card glass" style="border-left: 4px solid #EF4444;">
                    <h3 style="color: #EF4444;">‚ùå Error inesperado</h3>
                    <p style="margin-top: 1rem;">${err.message}</p>
                </div>
            `;
        }
    }

    function renderDailyTotalsChart(data) {
        if (dailyChart) dailyChart.destroy();
        const ctx = document.getElementById('dailyTotalsChart').getContext('2d');
        dailyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Kg Totales x D√≠a',
                    data: data.dataset_kg_produccion,
                    backgroundColor: 'rgba(16, 185, 129, 0.5)',
                    borderColor: '#10B981',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { color: '#94A3B8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    x: { ticks: { color: '#94A3B8' }, grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function renderChart(data) {
        if (mainChart) mainChart.destroy();
        const ctx = document.getElementById('resourceChart').getContext('2d');
        mainChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Operarios Max',
                        data: data.dataset_operarios,
                        type: 'line',
                        borderColor: '#6366F1',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        yAxisID: 'yOps',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Producci√≥n (Kg)',
                        data: data.dataset_kg_produccion,
                        backgroundColor: 'rgba(56, 189, 248, 0.3)',
                        borderColor: '#38BDF8',
                        borderWidth: 1,
                        yAxisID: 'yKg'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    yOps: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Operarios', color: '#6366F1' },
                        ticks: { color: '#6366F1' },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    },
                    yKg: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Kilogramos', color: '#38BDF8' },
                        ticks: { color: '#38BDF8' },
                        grid: { display: false }
                    },
                    x: { ticks: { color: '#94A3B8' }, grid: { display: false } }
                },
                plugins: {
                    legend: { labels: { color: '#F8FAFC' } }
                }
            }
        });
    }

    async function savePlan() {
        if (!currentPlan) return;
        try {
            const res = await fetch('/api/save_schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentPlan)
            });
            const data = await res.json();
            if (data.success) alert("¬°Plan guardado exitosamente!");
            else alert("Error al guardar: " + data.error);
        } catch (e) {
            console.error(e);
            alert("Error de conexi√≥n al guardar el plan.");
        }
    }

    function exportToPDF() {
        if (!currentPlan) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        const colors = {
            bg: [255, 255, 255],
            text: [15, 23, 42],
            muted: [100, 116, 139],
            accent: [59, 130, 246],
            headerBg: [255, 255, 255],
            cardBg: [248, 250, 252],
            border: [226, 232, 240]
        };

        const drawHeader = (d) => {
            d.setFillColor(...colors.bg);
            d.rect(0, 0, pageWidth, 80, 'F');

            d.setTextColor(...colors.text);
            d.setFontSize(18); d.setFont("helvetica", "bold");
            d.text("Plan de Producci√≥n Cabuyas Linea Cordeleria", 40, 45);

            d.setFontSize(10); d.setFont("helvetica", "normal"); d.setTextColor(...colors.muted);
            d.text(`Generado: ${new Date().toLocaleString()}`, 40, 65);

            d.setDrawColor(...colors.border);
            d.line(40, 75, pageWidth - 40, 75);
        };

        const drawFooter = (d, pNum, pTot) => {
            d.setFontSize(8); d.setTextColor(...colors.muted);
            d.text(`P√°gina ${pNum} de ${pTot}`, pageWidth / 2, pageHeight - 20, { align: 'center' });
        };

        const checkNewPage = (needed) => {
            if (yPos + needed > pageHeight - 60) {
                doc.addPage();
                drawHeader(doc);
                yPos = 110;
                return true;
            }
            return false;
        };

        // --- Calculation of "Dias trabajados" (excluding Sundays) ---
        let workingDaysCount = 0;
        if (currentPlan.cronograma_diario) {
            currentPlan.cronograma_diario.forEach(day => {
                const dateObj = new Date(day.fecha + 'T00:00:00');
                if (dateObj.getDay() !== 0) {
                    workingDaysCount++;
                }
            });
        }
        const displayedDays = workingDaysCount > 0 ? workingDaysCount : (currentPlan.resumen_global.total_dias_programados || 0);

        // --- Page 1: Metrics & Charts ---
        drawHeader(doc);
        let yPos = 100;

        // Metric Labels
        doc.setFontSize(10); doc.setTextColor(...colors.muted); doc.setFont("helvetica", "bold");
        doc.text("D√≠as Trabajados (Sin Domingos)", 40, yPos);
        doc.text("Total Kg en el Plan", 250, yPos);

        yPos += 20;

        // Metric Values
        doc.setFontSize(14); doc.setTextColor(...colors.text); doc.setFont("helvetica", "bold");
        doc.text(displayedDays.toString(), 40, yPos);
        doc.text((currentPlan.resumen_global.kg_totales_plan?.toLocaleString() || '0') + " kg", 250, yPos);

        yPos += 30;

        // Chart 1: Resource Chart (Kg & Personnel)
        try {
            const resCanvas = document.getElementById('resourceChart');
            if (resCanvas) {
                doc.setFontSize(11); doc.setTextColor(...colors.text); doc.setFont("helvetica", "bold");
                doc.text("Kilos diarios esperados en rewinder y # personas por d√≠a", 40, yPos);
                yPos += 15;
                doc.addImage(resCanvas.toDataURL("image/png", 0.9), 'PNG', 40, yPos, pageWidth - 80, 180);
                yPos += 200;
            }
        } catch (e) { console.error("Chart Error:", e); }

        // --- Detalle por d√≠a y turnos L√≠nea rewinder ---
        checkNewPage(40);
        doc.setFontSize(14); doc.setTextColor(...colors.text); doc.setFont("helvetica", "bold");
        doc.text("Detalle por d√≠a y turnos L√≠nea rewinder", 40, yPos);
        yPos += 25;

        // Iterate Days
        if (currentPlan.cronograma_diario) {
            currentPlan.cronograma_diario.forEach((dia) => {
                checkNewPage(120);

                // Day Header
                doc.setFillColor(...colors.cardBg);
                doc.rect(40, yPos - 15, pageWidth - 80, 25, 'F');
                doc.setFontSize(11); doc.setTextColor(...colors.text); doc.setFont("helvetica", "bold");
                doc.text(`Fecha: ${dia.fecha}`, 50, yPos + 2);
                yPos += 30;

                if (dia.turnos && dia.turnos.length > 0) {
                    dia.turnos.forEach(turno => {
                        checkNewPage(80);

                        doc.setFontSize(10); doc.setTextColor(...colors.accent); doc.setFont("helvetica", "bold");
                        doc.text(`Turno ${turno.nombre} (${turno.horario}) ‚Äî ${turno.operarios_requeridos} Operarios`, 40, yPos);
                        yPos += 10;

                        const tableRows = turno.asignaciones.map(a => [
                            a.referencia,
                            a.descripcion || '',
                            a.puestos,
                            a.operarios,
                            Math.round(a.kg_producidos).toLocaleString() + " kg"
                        ]);

                        doc.autoTable({
                            startY: yPos,
                            head: [['Referencia', 'Descripci√≥n', 'Puestos', 'Operarios', 'Producci√≥n (8h)']],
                            body: tableRows,
                            theme: 'plain',
                            headStyles: {
                                fillColor: [240, 240, 240],
                                textColor: [0, 0, 0],
                                fontStyle: 'bold',
                                lineWidth: 0.5,
                                lineColor: [200, 200, 200]
                            },
                            styles: {
                                fontSize: 9,
                                textColor: [50, 50, 50],
                                cellPadding: 4,
                                lineColor: [230, 230, 230],
                                lineWidth: 0.5
                            },
                            theme: 'grid',
                            columnStyles: {
                                0: { fontStyle: 'bold' },
                                4: { halign: 'right' }
                            },
                            margin: { left: 40, right: 40 }
                        });

                        yPos = doc.lastAutoTable.finalY + 20;
                    });
                } else {
                    doc.setFontSize(9); doc.setTextColor(...colors.muted); doc.setFont("helvetica", "italic");
                    doc.text("Sin producci√≥n programada (Domingo o Festivo)", 40, yPos);
                    yPos += 20;
                }
                yPos += 10;
            });
        }

        // --- Final Pages: Summary by Reference ---
        checkNewPage(100);
        doc.setFontSize(14); doc.setTextColor(...colors.text); doc.setFont("helvetica", "bold");
        doc.text("Resumen por Referencia (Terminaci√≥n)", 40, yPos); yPos += 20;

        const sumRows = currentPlan.tabla_finalizacion_referencias.map(r => [
            r.referencia,
            r.descripcion || '',
            r.fecha_finalizacion,
            Math.round(r.kg_totales).toLocaleString() + " kg"
        ]);

        doc.autoTable({
            startY: yPos,
            head: [['Referencia', 'Descripci√≥n', 'Fecha Terminaci√≥n', 'Total Kg']],
            body: sumRows,
            theme: 'grid',
            headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold', lineColor: [200, 200, 200], lineWidth: 0.5 },
            styles: { fontSize: 9, textColor: [50, 50, 50], lineColor: [230, 230, 230], lineWidth: 0.5 },
            columnStyles: { 3: { halign: 'right' } },
            margin: { left: 40, right: 40 }
        });

        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            drawFooter(doc, i, totalPages);
        }

        doc.save(`Plan_Produccion_Cordeleria_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    function switchScheduleTab(tabName, el) {
        // Update tab classes
        document.querySelectorAll('.schedule-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        // Toggle panels
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        const panel = document.getElementById('panel-' + tabName);
        if (panel) panel.classList.add('active');
    }

    function exportTorsionPDF() {
        if (!currentPlan) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'pt', 'a4'); // landscape for wider table
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        const colors = {
            text: [15, 23, 42],
            muted: [100, 116, 139],
            accent: [124, 58, 237], // purple
            border: [226, 232, 240]
        };

        const drawHeader = (d) => {
            d.setFillColor(255, 255, 255);
            d.rect(0, 0, pageWidth, 80, 'F');
            d.setTextColor(...colors.text);
            d.setFontSize(18); d.setFont("helvetica", "bold");
            d.text("Programaci√≥n L√≠nea de Torsi√≥n", 40, 45);
            d.setFontSize(10); d.setFont("helvetica", "normal"); d.setTextColor(...colors.muted);
            d.text(`Generado: ${new Date().toLocaleString()}`, 40, 65);
            d.setDrawColor(...colors.border);
            d.line(40, 75, pageWidth - 40, 75);
        };

        const drawFooter = (d, pNum, pTot) => {
            d.setFontSize(8); d.setTextColor(...colors.muted);
            d.text(`P√°gina ${pNum} de ${pTot}`, pageWidth / 2, pageHeight - 20, { align: 'center' });
        };

        let yPos = 100;

        const checkNewPage = (needed) => {
            if (yPos + needed > pageHeight - 60) {
                doc.addPage();
                drawHeader(doc);
                yPos = 100;
                return true;
            }
            return false;
        };

        drawHeader(doc);

        if (currentPlan.cronograma_diario) {
            currentPlan.cronograma_diario.forEach(dia => {
                const torsionTurnos = dia.turnos_torsion || [];
                if (torsionTurnos.length === 0) return;

                checkNewPage(120);

                // Day header
                doc.setFillColor(248, 250, 252);
                doc.rect(40, yPos - 15, pageWidth - 80, 25, 'F');
                doc.setFontSize(11); doc.setTextColor(...colors.text); doc.setFont("helvetica", "bold");
                doc.text(`Fecha: ${dia.fecha}`, 50, yPos + 2);
                yPos += 30;

                torsionTurnos.forEach(turno => {
                    checkNewPage(80);

                    doc.setFontSize(10); doc.setTextColor(...colors.accent); doc.setFont("helvetica", "bold");
                    doc.text(`Turno ${turno.nombre} (${turno.horario}) ‚Äî ${turno.operarios_requeridos} Operarios`, 40, yPos);
                    yPos += 10;

                    const tableRows = turno.asignaciones.map(a => {
                        const util = a.husos_totales > 0 ? Math.round((a.husos_asignados / a.husos_totales) * 100) + '%' : '-';
                        return [
                            a.maquina,
                            a.referencia,
                            a.denier,
                            `${a.husos_asignados} / ${a.husos_totales} (${util})`,
                            a.kgh_maquina,
                            Math.round(a.kg_turno).toLocaleString() + " kg",
                            a.operarios
                        ];
                    });

                    doc.autoTable({
                        startY: yPos,
                        head: [['M√°quina', 'Referencia', 'Denier', 'Husos', 'Kg/h M√°q.', 'Prod (8h)', 'Ops']],
                        body: tableRows,
                        theme: 'grid',
                        headStyles: { fillColor: [124, 58, 237], textColor: [255, 255, 255] },
                        margin: { left: 40, right: 40 }
                    });

                    yPos = doc.lastAutoTable.finalY + 20;
                });
            });
        }

        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            drawFooter(doc, i, totalPages);
        }

        doc.save(`Plan_Torsion_${new Date().toISOString().split('T')[0]}.pdf`);
    }
</script>
{% endblock %}
