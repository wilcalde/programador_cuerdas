{% extends "base.html" %}

{% block header_title %}üìÖ Programaci√≥n de Producci√≥n{% endblock %}

{% block content %}
<div class="card glass" style="border-left: 4px solid var(--accent-blue);">
    <p>üí° La programaci√≥n es generada por IA bas√°ndose en el backlog y la capacidad de los 28 puestos de Rewinder
        disponible.</p>
</div>

<div
    style="margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color);">
    <div style="display: flex; gap: 2rem; align-items: center;">
        <span style="font-weight: 600; color: #94A3B8;">Criterio de Optimizaci√≥n:</span>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #F8FAFC;">
            <input type="radio" name="strategy" value="kg" checked style="accent-color: var(--accent-blue);">
            Maximizar Kg
        </label>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: #F8FAFC;">
            <input type="radio" name="strategy" value="priority" style="accent-color: var(--accent-blue);">
            Prioridades Primero ‚≠ê
        </label>
    </div>
    <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
        <button class="btn btn-primary" onclick="generateSchedule()" style="min-width: 250px; font-weight: 700;">
            <i class="bi bi-magic"></i> Generar programaci√≥n
        </button>
    </div>
</div>

<div id="loading" style="display: none; margin-top: 2rem; text-align: center;">
    <div class="spinner"
        style="border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;">
    </div>
    <p style="margin-top: 1rem; color: #38BDF8;">ü§ñ IA analizando backlog y capacidades...</p>
</div>

<div id="results" style="margin-top: 2rem;">
    <div class="card glass" style="text-align: center; padding: 3rem;">
        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #1E293B;"></i>
        <p style="color: #94A3B8; margin-top: 1rem;">A√∫n no se ha generado una programaci√≥n din√°mica para este periodo.
        </p>
    </div>
</div>

<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        margin-top: 2rem;
        background: rgba(0, 0, 0, 0.2);
        padding: 1rem;
        border-radius: 8px;
    }
    .schedule-tabs {
        display: flex;
        gap: 0;
        margin: 2rem 0 1.5rem;
        border-bottom: 2px solid var(--border-color);
    }
    .schedule-tab {
        padding: 0.75rem 2rem;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        color: #94A3B8;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
        user-select: none;
    }
    .schedule-tab:hover { color: #F8FAFC; }
    .schedule-tab.active {
        color: #38BDF8;
        border-bottom-color: #38BDF8;
    }
    .schedule-tab.torsion-tab.active {
        color: #A78BFA;
        border-bottom-color: #A78BFA;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
    let currentPlan = null;
    let mainChart = null;
    let dailyChart = null;

    async function generateSchedule() {
        const strategy = document.querySelector('input[name="strategy"]:checked').value;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').innerHTML = '';

        try {
            const response = await fetch('/api/generate_schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ strategy: strategy })
            });
            const data = await response.json();
            document.getElementById('loading').style.display = 'none';

            if (!response.ok || data.error) {
                document.getElementById('results').innerHTML = `<div class="card glass"><p>${data.error || 'Error'}</p></div>`;
                return;
            }

            const scenario = data.scenario;
            currentPlan = scenario;
            const res = scenario.resumen_global;

            let html = `
            <div class="card glass" style="border-top: 4px solid #10B981; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between;">
                    <div><h3>‚úÖ Programaci√≥n Exitosa</h3><p>${res.comentario_estrategia}</p></div>
                    <div><button class="btn btn-secondary" onclick="savePlan()">Guardar</button> <button class="btn btn-primary" onclick="exportToPDF()">PDF</button></div>
                </div>
                <div class="grid" style="margin-top: 1rem;">
                    <div class="card"><div class="metric-label">Total Kg</div><div class="metric-value">${res.kg_totales_plan} kg</div></div>
                    <div class="card"><div class="metric-label">D√≠as</div><div class="metric-value">${res.total_dias_programados}</div></div>
                </div>
                <div class="chart-container"><canvas id="resourceChart"></canvas></div>
            </div>`;

            html += `<div class="schedule-tabs"><div class="schedule-tab active" onclick="switchScheduleTab('rewinder', this)">üîÑ Rewinder</div><div class="schedule-tab torsion-tab" onclick="switchScheduleTab('torsion', this)">‚öôÔ∏è Torsi√≥n</div></div>`;
            html += `<div id="panel-rewinder" class="tab-panel active"><h2>Cronograma Rewinder</h2>`;
            scenario.cronograma_diario.forEach(dia => {
                html += `<div class="card glass"><h3>${dia.fecha}</h3>`;
                dia.turnos.forEach(t => {
                    html += `<h4>Turno ${t.nombre} (${t.horario})</h4><table><thead><tr><th>Ref</th><th>Posts</th><th>Kg</th></tr></thead><tbody>`;
                    t.asignaciones.forEach(a => { html += `<tr><td>${a.referencia}</td><td>${a.puestos}</td><td>${a.kg_producidos}</td></tr>`; });
                    html += `</tbody></table>`;
                });
                html += `</div>`;
            });
            html += `</div>`;

            html += `<div id="panel-torsion" class="tab-panel"><h2>Cronograma Torsi√≥n</h2>`;
            scenario.cronograma_diario.forEach(dia => {
                html += `<div class="card glass"><h3>${dia.fecha}</h3>`;
                dia.turnos_torsion.forEach(t => {
                    html += `<h4>Turno ${t.nombre}</h4><table><thead><tr><th>M√°q</th><th>Ref</th><th>Husos</th></tr></thead><tbody>`;
                    t.asignaciones.forEach(a => { html += `<tr><td>${a.maquina}</td><td>${a.referencia}</td><td>${a.husos_asignados}</td></tr>`; });
                    html += `</tbody></table>`;
                });
                html += `</div>`;
            });
            html += `</div>`;

            document.getElementById('results').innerHTML = html;
            renderChart(scenario.datos_para_grafica);
        } catch (err) { console.error(err); }
    }

    function renderChart(data) {
        if (mainChart) mainChart.destroy();
        const ctx = document.getElementById('resourceChart').getContext('2d');
        mainChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    { label: 'Ops', data: data.dataset_operarios, type: 'line', yAxisID: 'yOps' },
                    { label: 'Kg', data: data.dataset_kg_produccion, yAxisID: 'yKg' }
                ]
            },
            options: { scales: { yOps: { position: 'left' }, yKg: { position: 'right' } } }
        });
    }

    async function savePlan() {
        if (!currentPlan) return;
        const res = await fetch('/api/save_schedule', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ plan: currentPlan }) });
        const data = await res.json();
        alert(data.success ? "¬°Guardado!" : "Error: " + data.error);
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Plan de Producci√≥n", 10, 10);
        doc.save("Plan.pdf");
    }

    function switchScheduleTab(name, el) {
        document.querySelectorAll('.schedule-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('panel-' + name).classList.add('active');
    }

    function exportTorsionPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Plan de Torsi√≥n", 10, 10);
        doc.save("Torsion.pdf");
    }
</script>
{% endblock %}
